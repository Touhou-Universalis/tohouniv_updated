th_has_danmaku_duels_unlocked = {
	custom_trigger_tooltip = {
		tooltip = th_has_danmaku_duels_unlocked_tt
		OR = {
			technology_group = tech_gensokyan_lunarian
			technology_group = tech_lunarian
			technology_group = tech_gensokyan
		}
	}
}

th_has_not_danmaku_duels_unlocked = {
	custom_trigger_tooltip = {
		tooltip = th_has_not_danmaku_duels_unlocked_tt
		NOT = { technology_group = tech_gensokyan_lunarian }
		NOT = { technology_group = tech_lunarian }
		NOT = { technology_group = tech_gensokyan }
	}
}

th_is_in_a_danmaku_duel = {
	custom_trigger_tooltip = {
		tooltip = th_is_in_a_danmaku_duel_tt
		has_ruler_flag = th_ruler_is_in_a_danmaku_duel
	}
	is_lesser_in_union = no
}

th_is_not_in_a_danmaku_duel = {
	custom_trigger_tooltip = {
		tooltip = th_is_not_in_a_danmaku_duel_tt
		NOT = { has_ruler_flag = th_ruler_is_in_a_danmaku_duel }
	}
}

th_is_duelling_an_unlanded_character = {
	custom_trigger_tooltip = {
		tooltip = th_is_duelling_an_unlanded_character_tt
		has_ruler_flag = th_is_duelling_an_unlanded_character
	}
}
th_is_not_duelling_an_unlanded_character = {
	custom_trigger_tooltip = {
		tooltip = th_is_not_duelling_an_unlanded_character_tt
		NOT = { has_ruler_flag = th_is_duelling_an_unlanded_character }
	}
}

th_get_unlanded_character_home = {
	has_country_flag = th_unlanded_character_home_$home$
}

th_is_duelling_character = {
	custom_trigger_tooltip = {
		tooltip = th_is_duelling_character_$target$_tt
		has_country_flag = th_is_duelling_character_$target$
	}
}

th_get_danmaku_duel_instance = {
	custom_trigger_tooltip = {
		tooltip = th_get_danmaku_duel_instance_$instance$_tt
		has_country_flag = th_is_in_danmaku_duel_instance_$instance$
	}
}

th_is_danmaku_duel_global_event_target = {
	has_saved_global_event_target = th_danmaku_duelist_of_id_$country_id$_of_instance_$instance$
	has_country_flag = th_is_in_danmaku_duel_instance_$instance$
	tag = event_target:th_danmaku_duelist_of_id_$country_id$_of_instance_$instance$
}

th_is_not_danmaku_duel_enemy_target = {
	has_saved_global_event_target = th_danmaku_duelist_of_id_$country_id$_of_instance_$instance$
	has_country_flag = th_is_in_danmaku_duel_instance_$instance$
	NOT = { tag = event_target:th_danmaku_duelist_of_id_$country_id$_of_instance_$instance$ }
}

th_is_country_id_danmaku_duel = {
	OR = {
		th_is_danmaku_duel_global_event_target = { instance = 1 country_id = $country_id$ }
		th_is_danmaku_duel_global_event_target = { instance = 2 country_id = $country_id$ }
		th_is_danmaku_duel_global_event_target = { instance = 3 country_id = $country_id$ }
		th_is_danmaku_duel_global_event_target = { instance = 4 country_id = $country_id$ }
		th_is_danmaku_duel_global_event_target = { instance = 5 country_id = $country_id$ }
		th_is_danmaku_duel_global_event_target = { instance = 6 country_id = $country_id$ }
		th_is_danmaku_duel_global_event_target = { instance = 7 country_id = $country_id$ }
		th_is_danmaku_duel_global_event_target = { instance = 8 country_id = $country_id$ }
		th_is_danmaku_duel_global_event_target = { instance = 9 country_id = $country_id$ }
		th_is_danmaku_duel_global_event_target = { instance = 10 country_id = $country_id$ }
		th_is_danmaku_duel_global_event_target = { instance = 11 country_id = $country_id$ }
		th_is_danmaku_duel_global_event_target = { instance = 12 country_id = $country_id$ }
		th_is_danmaku_duel_global_event_target = { instance = 13 country_id = $country_id$ }
		th_is_danmaku_duel_global_event_target = { instance = 14 country_id = $country_id$ }
		th_is_danmaku_duel_global_event_target = { instance = 15 country_id = $country_id$ }
		th_is_danmaku_duel_global_event_target = { instance = 16 country_id = $country_id$ }
		th_is_danmaku_duel_global_event_target = { instance = 17 country_id = $country_id$ }
		th_is_danmaku_duel_global_event_target = { instance = 18 country_id = $country_id$ }
		th_is_danmaku_duel_global_event_target = { instance = 19 country_id = $country_id$ }
		th_is_danmaku_duel_global_event_target = { instance = 20 country_id = $country_id$ }
		th_is_danmaku_duel_global_event_target = { instance = 21 country_id = $country_id$ }
		th_is_danmaku_duel_global_event_target = { instance = 22 country_id = $country_id$ }
		th_is_danmaku_duel_global_event_target = { instance = 23 country_id = $country_id$ }
		th_is_danmaku_duel_global_event_target = { instance = 24 country_id = $country_id$ }
		th_is_danmaku_duel_global_event_target = { instance = 25 country_id = $country_id$ }
		th_is_danmaku_duel_global_event_target = { instance = 26 country_id = $country_id$ }
		th_is_danmaku_duel_global_event_target = { instance = 27 country_id = $country_id$ }
		th_is_danmaku_duel_global_event_target = { instance = 28 country_id = $country_id$ }
		th_is_danmaku_duel_global_event_target = { instance = 29 country_id = $country_id$ }
		th_is_danmaku_duel_global_event_target = { instance = 30 country_id = $country_id$ }
	}
}

th_has_turn_ownership = {
	custom_trigger_tooltip = {
		tooltip = th_has_turn_ownership_tt
		has_ruler_flag = th_danmaku_has_turn_ownership
	}
}

th_has_not_turn_ownership = {
	custom_trigger_tooltip = {
		tooltip = th_has_not_turn_ownership_tt
		NOT = { has_ruler_flag = th_danmaku_has_turn_ownership }
	}
}

th_unlanded_character_has_turn_ownership = {
	custom_trigger_tooltip = {
		tooltip = th_has_turn_ownership_tt
		has_ruler_flag = th_danmaku_unlanded_character_turn_ownership
	}
}

th_unlanded_character_has_not_turn_ownership = {
	custom_trigger_tooltip = {
		tooltip = th_has_not_turn_ownership_tt
		NOT = { has_ruler_flag = th_danmaku_unlanded_character_turn_ownership }
	}
}

th_gui_can_press_danmaku_buttons = {
	if = {
		limit = { th_has_not_turn_ownership = yes }
		custom_trigger_tooltip = {
			tooltip = TH_HAS_CURRENTLY_NOT_THE_TURN_TT
			th_has_turn_ownership = yes
		}
	}
	if = {
		limit = { has_country_flag = th_danmaku_locked_actions }
		custom_trigger_tooltip = {
			tooltip = TH_COMBAT_WINDOW_IS_FROZEN_TT
			NOT = { has_country_flag = th_danmaku_locked_actions }
		}
	}
}

th_enemy_is_touhou_character = {
	th_is_in_a_danmaku_duel = yes
	OR = {
		AND = {
			th_is_duelling_an_unlanded_character = yes
			th_is_duelling_character = { target = $who$ }
		}
		AND = {
			th_is_not_duelling_an_unlanded_character = yes
			OR = {
				AND = {
					th_is_not_danmaku_duel_enemy_target = { country_id = 1 instance = 1 }
					event_target:th_danmaku_duelist_of_id_1_of_instance_1 = { th_has_specific_touhou_character = { who = $who$ } }
				}
				AND = {
					th_is_not_danmaku_duel_enemy_target = { country_id = 1 instance = 2 }
					event_target:th_danmaku_duelist_of_id_1_of_instance_2 = { th_has_specific_touhou_character = { who = $who$ } }
				}
				AND = {
					th_is_not_danmaku_duel_enemy_target = { country_id = 1 instance = 3 }
					event_target:th_danmaku_duelist_of_id_1_of_instance_3 = { th_has_specific_touhou_character = { who = $who$ } }
				}
				AND = {
					th_is_not_danmaku_duel_enemy_target = { country_id = 1 instance = 4 }
					event_target:th_danmaku_duelist_of_id_1_of_instance_4 = { th_has_specific_touhou_character = { who = $who$ } }
				}
				AND = {
					th_is_not_danmaku_duel_enemy_target = { country_id = 1 instance = 5 }
					event_target:th_danmaku_duelist_of_id_1_of_instance_5 = { th_has_specific_touhou_character = { who = $who$ } }
				}
				AND = {
					th_is_not_danmaku_duel_enemy_target = { country_id = 1 instance = 6 }
					event_target:th_danmaku_duelist_of_id_1_of_instance_6 = { th_has_specific_touhou_character = { who = $who$ } }
				}
				AND = {
					th_is_not_danmaku_duel_enemy_target = { country_id = 1 instance = 7 }
					event_target:th_danmaku_duelist_of_id_1_of_instance_7 = { th_has_specific_touhou_character = { who = $who$ } }
				}
				AND = {
					th_is_not_danmaku_duel_enemy_target = { country_id = 1 instance = 8 }
					event_target:th_danmaku_duelist_of_id_1_of_instance_8 = { th_has_specific_touhou_character = { who = $who$ } }
				}
				AND = {
					th_is_not_danmaku_duel_enemy_target = { country_id = 1 instance = 9 }
					event_target:th_danmaku_duelist_of_id_1_of_instance_9 = { th_has_specific_touhou_character = { who = $who$ } }
				}
				AND = {
					th_is_not_danmaku_duel_enemy_target = { country_id = 1 instance = 10 }
					event_target:th_danmaku_duelist_of_id_1_of_instance_10 = { th_has_specific_touhou_character = { who = $who$ } }
				}
				AND = {
					th_is_not_danmaku_duel_enemy_target = { country_id = 1 instance = 11 }
					event_target:th_danmaku_duelist_of_id_1_of_instance_11 = { th_has_specific_touhou_character = { who = $who$ } }
				}
				AND = {
					th_is_not_danmaku_duel_enemy_target = { country_id = 1 instance = 12 }
					event_target:th_danmaku_duelist_of_id_1_of_instance_12 = { th_has_specific_touhou_character = { who = $who$ } }
				}
				AND = {
					th_is_not_danmaku_duel_enemy_target = { country_id = 1 instance = 13 }
					event_target:th_danmaku_duelist_of_id_1_of_instance_13 = { th_has_specific_touhou_character = { who = $who$ } }
				}
				AND = {
					th_is_not_danmaku_duel_enemy_target = { country_id = 1 instance = 14 }
					event_target:th_danmaku_duelist_of_id_1_of_instance_14 = { th_has_specific_touhou_character = { who = $who$ } }
				}
				AND = {
					th_is_not_danmaku_duel_enemy_target = { country_id = 1 instance = 15 }
					event_target:th_danmaku_duelist_of_id_1_of_instance_15 = { th_has_specific_touhou_character = { who = $who$ } }
				}
				AND = {
					th_is_not_danmaku_duel_enemy_target = { country_id = 1 instance = 16 }
					event_target:th_danmaku_duelist_of_id_1_of_instance_16 = { th_has_specific_touhou_character = { who = $who$ } }
				}
				AND = {
					th_is_not_danmaku_duel_enemy_target = { country_id = 1 instance = 17 }
					event_target:th_danmaku_duelist_of_id_1_of_instance_17 = { th_has_specific_touhou_character = { who = $who$ } }
				}
				AND = {
					th_is_not_danmaku_duel_enemy_target = { country_id = 1 instance = 18 }
					event_target:th_danmaku_duelist_of_id_1_of_instance_18 = { th_has_specific_touhou_character = { who = $who$ } }
				}
				AND = {
					th_is_not_danmaku_duel_enemy_target = { country_id = 1 instance = 19 }
					event_target:th_danmaku_duelist_of_id_1_of_instance_19 = { th_has_specific_touhou_character = { who = $who$ } }
				}
				AND = {
					th_is_not_danmaku_duel_enemy_target = { country_id = 1 instance = 20 }
					event_target:th_danmaku_duelist_of_id_1_of_instance_20 = { th_has_specific_touhou_character = { who = $who$ } }
				}
				AND = {
					th_is_not_danmaku_duel_enemy_target = { country_id = 1 instance = 21 }
					event_target:th_danmaku_duelist_of_id_1_of_instance_21 = { th_has_specific_touhou_character = { who = $who$ } }
				}
				AND = {
					th_is_not_danmaku_duel_enemy_target = { country_id = 1 instance = 22 }
					event_target:th_danmaku_duelist_of_id_1_of_instance_22 = { th_has_specific_touhou_character = { who = $who$ } }
				}
				AND = {
					th_is_not_danmaku_duel_enemy_target = { country_id = 1 instance = 23 }
					event_target:th_danmaku_duelist_of_id_1_of_instance_23 = { th_has_specific_touhou_character = { who = $who$ } }
				}
				AND = {
					th_is_not_danmaku_duel_enemy_target = { country_id = 1 instance = 24 }
					event_target:th_danmaku_duelist_of_id_1_of_instance_24 = { th_has_specific_touhou_character = { who = $who$ } }
				}
				AND = {
					th_is_not_danmaku_duel_enemy_target = { country_id = 1 instance = 25 }
					event_target:th_danmaku_duelist_of_id_1_of_instance_25 = { th_has_specific_touhou_character = { who = $who$ } }
				}
				AND = {
					th_is_not_danmaku_duel_enemy_target = { country_id = 1 instance = 26 }
					event_target:th_danmaku_duelist_of_id_1_of_instance_26 = { th_has_specific_touhou_character = { who = $who$ } }
				}
				AND = {
					th_is_not_danmaku_duel_enemy_target = { country_id = 1 instance = 27 }
					event_target:th_danmaku_duelist_of_id_1_of_instance_27 = { th_has_specific_touhou_character = { who = $who$ } }
				}
				AND = {
					th_is_not_danmaku_duel_enemy_target = { country_id = 1 instance = 28 }
					event_target:th_danmaku_duelist_of_id_1_of_instance_28 = { th_has_specific_touhou_character = { who = $who$ } }
				}
				AND = {
					th_is_not_danmaku_duel_enemy_target = { country_id = 1 instance = 29 }
					event_target:th_danmaku_duelist_of_id_1_of_instance_29 = { th_has_specific_touhou_character = { who = $who$ } }
				}
				AND = {
					th_is_not_danmaku_duel_enemy_target = { country_id = 1 instance = 30 }
					event_target:th_danmaku_duelist_of_id_1_of_instance_30 = { th_has_specific_touhou_character = { who = $who$ } }
				}
				AND = {
					th_is_not_danmaku_duel_enemy_target = { country_id = 2 instance = 1 }
					event_target:th_danmaku_duelist_of_id_2_of_instance_1 = { th_has_specific_touhou_character = { who = $who$ } }
				}
				AND = {
					th_is_not_danmaku_duel_enemy_target = { country_id = 2 instance = 2 }
					event_target:th_danmaku_duelist_of_id_2_of_instance_2 = { th_has_specific_touhou_character = { who = $who$ } }
				}
				AND = {
					th_is_not_danmaku_duel_enemy_target = { country_id = 2 instance = 3 }
					event_target:th_danmaku_duelist_of_id_2_of_instance_3 = { th_has_specific_touhou_character = { who = $who$ } }
				}
				AND = {
					th_is_not_danmaku_duel_enemy_target = { country_id = 2 instance = 4 }
					event_target:th_danmaku_duelist_of_id_2_of_instance_4 = { th_has_specific_touhou_character = { who = $who$ } }
				}
				AND = {
					th_is_not_danmaku_duel_enemy_target = { country_id = 2 instance = 5 }
					event_target:th_danmaku_duelist_of_id_2_of_instance_5 = { th_has_specific_touhou_character = { who = $who$ } }
				}
				AND = {
					th_is_not_danmaku_duel_enemy_target = { country_id = 2 instance = 6 }
					event_target:th_danmaku_duelist_of_id_2_of_instance_6 = { th_has_specific_touhou_character = { who = $who$ } }
				}
				AND = {
					th_is_not_danmaku_duel_enemy_target = { country_id = 2 instance = 7 }
					event_target:th_danmaku_duelist_of_id_2_of_instance_7 = { th_has_specific_touhou_character = { who = $who$ } }
				}
				AND = {
					th_is_not_danmaku_duel_enemy_target = { country_id = 2 instance = 8 }
					event_target:th_danmaku_duelist_of_id_2_of_instance_8 = { th_has_specific_touhou_character = { who = $who$ } }
				}
				AND = {
					th_is_not_danmaku_duel_enemy_target = { country_id = 2 instance = 9 }
					event_target:th_danmaku_duelist_of_id_2_of_instance_9 = { th_has_specific_touhou_character = { who = $who$ } }
				}
				AND = {
					th_is_not_danmaku_duel_enemy_target = { country_id = 2 instance = 10 }
					event_target:th_danmaku_duelist_of_id_2_of_instance_10 = { th_has_specific_touhou_character = { who = $who$ } }
				}
				AND = {
					th_is_not_danmaku_duel_enemy_target = { country_id = 2 instance = 11 }
					event_target:th_danmaku_duelist_of_id_2_of_instance_11 = { th_has_specific_touhou_character = { who = $who$ } }
				}
				AND = {
					th_is_not_danmaku_duel_enemy_target = { country_id = 2 instance = 12 }
					event_target:th_danmaku_duelist_of_id_2_of_instance_12 = { th_has_specific_touhou_character = { who = $who$ } }
				}
				AND = {
					th_is_not_danmaku_duel_enemy_target = { country_id = 2 instance = 13 }
					event_target:th_danmaku_duelist_of_id_2_of_instance_13 = { th_has_specific_touhou_character = { who = $who$ } }
				}
				AND = {
					th_is_not_danmaku_duel_enemy_target = { country_id = 2 instance = 14 }
					event_target:th_danmaku_duelist_of_id_2_of_instance_14 = { th_has_specific_touhou_character = { who = $who$ } }
				}
				AND = {
					th_is_not_danmaku_duel_enemy_target = { country_id = 2 instance = 15 }
					event_target:th_danmaku_duelist_of_id_2_of_instance_15 = { th_has_specific_touhou_character = { who = $who$ } }
				}
				AND = {
					th_is_not_danmaku_duel_enemy_target = { country_id = 2 instance = 16 }
					event_target:th_danmaku_duelist_of_id_2_of_instance_16 = { th_has_specific_touhou_character = { who = $who$ } }
				}
				AND = {
					th_is_not_danmaku_duel_enemy_target = { country_id = 2 instance = 17 }
					event_target:th_danmaku_duelist_of_id_2_of_instance_17 = { th_has_specific_touhou_character = { who = $who$ } }
				}
				AND = {
					th_is_not_danmaku_duel_enemy_target = { country_id = 2 instance = 18 }
					event_target:th_danmaku_duelist_of_id_2_of_instance_18 = { th_has_specific_touhou_character = { who = $who$ } }
				}
				AND = {
					th_is_not_danmaku_duel_enemy_target = { country_id = 2 instance = 19 }
					event_target:th_danmaku_duelist_of_id_2_of_instance_19 = { th_has_specific_touhou_character = { who = $who$ } }
				}
				AND = {
					th_is_not_danmaku_duel_enemy_target = { country_id = 2 instance = 20 }
					event_target:th_danmaku_duelist_of_id_2_of_instance_20 = { th_has_specific_touhou_character = { who = $who$ } }
				}
				AND = {
					th_is_not_danmaku_duel_enemy_target = { country_id = 2 instance = 21 }
					event_target:th_danmaku_duelist_of_id_2_of_instance_21 = { th_has_specific_touhou_character = { who = $who$ } }
				}
				AND = {
					th_is_not_danmaku_duel_enemy_target = { country_id = 2 instance = 22 }
					event_target:th_danmaku_duelist_of_id_2_of_instance_22 = { th_has_specific_touhou_character = { who = $who$ } }
				}
				AND = {
					th_is_not_danmaku_duel_enemy_target = { country_id = 2 instance = 23 }
					event_target:th_danmaku_duelist_of_id_2_of_instance_23 = { th_has_specific_touhou_character = { who = $who$ } }
				}
				AND = {
					th_is_not_danmaku_duel_enemy_target = { country_id = 2 instance = 24 }
					event_target:th_danmaku_duelist_of_id_2_of_instance_24 = { th_has_specific_touhou_character = { who = $who$ } }
				}
				AND = {
					th_is_not_danmaku_duel_enemy_target = { country_id = 2 instance = 25 }
					event_target:th_danmaku_duelist_of_id_2_of_instance_25 = { th_has_specific_touhou_character = { who = $who$ } }
				}
				AND = {
					th_is_not_danmaku_duel_enemy_target = { country_id = 2 instance = 26 }
					event_target:th_danmaku_duelist_of_id_2_of_instance_26 = { th_has_specific_touhou_character = { who = $who$ } }
				}
				AND = {
					th_is_not_danmaku_duel_enemy_target = { country_id = 2 instance = 27 }
					event_target:th_danmaku_duelist_of_id_2_of_instance_27 = { th_has_specific_touhou_character = { who = $who$ } }
				}
				AND = {
					th_is_not_danmaku_duel_enemy_target = { country_id = 2 instance = 28 }
					event_target:th_danmaku_duelist_of_id_2_of_instance_28 = { th_has_specific_touhou_character = { who = $who$ } }
				}
				AND = {
					th_is_not_danmaku_duel_enemy_target = { country_id = 2 instance = 29 }
					event_target:th_danmaku_duelist_of_id_2_of_instance_29 = { th_has_specific_touhou_character = { who = $who$ } }
				}
				AND = {
					th_is_not_danmaku_duel_enemy_target = { country_id = 2 instance = 30 }
					event_target:th_danmaku_duelist_of_id_2_of_instance_30 = { th_has_specific_touhou_character = { who = $who$ } }
				}
			}
		}
	}
}

th_enemy_is_class = {
	th_is_in_a_danmaku_duel = yes
	OR = {
		AND = {
			th_is_duelling_an_unlanded_character = yes
			th_unlanded_character_is_danmaku_class = { class = $class$ }
		}
		AND = {
			th_is_not_duelling_an_unlanded_character = yes
			OR = {
				AND = {
					th_is_not_danmaku_duel_enemy_target = { country_id = 1 instance = 1 }
					event_target:th_danmaku_duelist_of_id_1_of_instance_1 = { th_is_danmaku_class = { class = $class$ } }
				}
				AND = {
					th_is_not_danmaku_duel_enemy_target = { country_id = 1 instance = 2 }
					event_target:th_danmaku_duelist_of_id_1_of_instance_2 = { th_is_danmaku_class = { class = $class$ } }
				}
				AND = {
					th_is_not_danmaku_duel_enemy_target = { country_id = 1 instance = 3 }
					event_target:th_danmaku_duelist_of_id_1_of_instance_3 = { th_is_danmaku_class = { class = $class$ } }
				}
				AND = {
					th_is_not_danmaku_duel_enemy_target = { country_id = 1 instance = 4 }
					event_target:th_danmaku_duelist_of_id_1_of_instance_4 = { th_is_danmaku_class = { class = $class$ } }
				}
				AND = {
					th_is_not_danmaku_duel_enemy_target = { country_id = 1 instance = 5 }
					event_target:th_danmaku_duelist_of_id_1_of_instance_5 = { th_is_danmaku_class = { class = $class$ } }
				}
				AND = {
					th_is_not_danmaku_duel_enemy_target = { country_id = 1 instance = 6 }
					event_target:th_danmaku_duelist_of_id_1_of_instance_6 = { th_is_danmaku_class = { class = $class$ } }
				}
				AND = {
					th_is_not_danmaku_duel_enemy_target = { country_id = 1 instance = 7 }
					event_target:th_danmaku_duelist_of_id_1_of_instance_7 = { th_is_danmaku_class = { class = $class$ } }
				}
				AND = {
					th_is_not_danmaku_duel_enemy_target = { country_id = 1 instance = 8 }
					event_target:th_danmaku_duelist_of_id_1_of_instance_8 = { th_is_danmaku_class = { class = $class$ } }
				}
				AND = {
					th_is_not_danmaku_duel_enemy_target = { country_id = 1 instance = 9 }
					event_target:th_danmaku_duelist_of_id_1_of_instance_9 = { th_is_danmaku_class = { class = $class$ } }
				}
				AND = {
					th_is_not_danmaku_duel_enemy_target = { country_id = 1 instance = 10 }
					event_target:th_danmaku_duelist_of_id_1_of_instance_10 = { th_is_danmaku_class = { class = $class$ } }
				}
				AND = {
					th_is_not_danmaku_duel_enemy_target = { country_id = 1 instance = 11 }
					event_target:th_danmaku_duelist_of_id_1_of_instance_11 = { th_is_danmaku_class = { class = $class$ } }
				}
				AND = {
					th_is_not_danmaku_duel_enemy_target = { country_id = 1 instance = 12 }
					event_target:th_danmaku_duelist_of_id_1_of_instance_12 = { th_is_danmaku_class = { class = $class$ } }
				}
				AND = {
					th_is_not_danmaku_duel_enemy_target = { country_id = 1 instance = 13 }
					event_target:th_danmaku_duelist_of_id_1_of_instance_13 = { th_is_danmaku_class = { class = $class$ } }
				}
				AND = {
					th_is_not_danmaku_duel_enemy_target = { country_id = 1 instance = 14 }
					event_target:th_danmaku_duelist_of_id_1_of_instance_14 = { th_is_danmaku_class = { class = $class$ } }
				}
				AND = {
					th_is_not_danmaku_duel_enemy_target = { country_id = 1 instance = 15 }
					event_target:th_danmaku_duelist_of_id_1_of_instance_15 = { th_is_danmaku_class = { class = $class$ } }
				}
				AND = {
					th_is_not_danmaku_duel_enemy_target = { country_id = 1 instance = 16 }
					event_target:th_danmaku_duelist_of_id_1_of_instance_16 = { th_is_danmaku_class = { class = $class$ } }
				}
				AND = {
					th_is_not_danmaku_duel_enemy_target = { country_id = 1 instance = 17 }
					event_target:th_danmaku_duelist_of_id_1_of_instance_17 = { th_is_danmaku_class = { class = $class$ } }
				}
				AND = {
					th_is_not_danmaku_duel_enemy_target = { country_id = 1 instance = 18 }
					event_target:th_danmaku_duelist_of_id_1_of_instance_18 = { th_is_danmaku_class = { class = $class$ } }
				}
				AND = {
					th_is_not_danmaku_duel_enemy_target = { country_id = 1 instance = 19 }
					event_target:th_danmaku_duelist_of_id_1_of_instance_19 = { th_is_danmaku_class = { class = $class$ } }
				}
				AND = {
					th_is_not_danmaku_duel_enemy_target = { country_id = 1 instance = 20 }
					event_target:th_danmaku_duelist_of_id_1_of_instance_20 = { th_is_danmaku_class = { class = $class$ } }
				}
				AND = {
					th_is_not_danmaku_duel_enemy_target = { country_id = 1 instance = 21 }
					event_target:th_danmaku_duelist_of_id_1_of_instance_21 = { th_is_danmaku_class = { class = $class$ } }
				}
				AND = {
					th_is_not_danmaku_duel_enemy_target = { country_id = 1 instance = 22 }
					event_target:th_danmaku_duelist_of_id_1_of_instance_22 = { th_is_danmaku_class = { class = $class$ } }
				}
				AND = {
					th_is_not_danmaku_duel_enemy_target = { country_id = 1 instance = 23 }
					event_target:th_danmaku_duelist_of_id_1_of_instance_23 = { th_is_danmaku_class = { class = $class$ } }
				}
				AND = {
					th_is_not_danmaku_duel_enemy_target = { country_id = 1 instance = 24 }
					event_target:th_danmaku_duelist_of_id_1_of_instance_24 = { th_is_danmaku_class = { class = $class$ } }
				}
				AND = {
					th_is_not_danmaku_duel_enemy_target = { country_id = 1 instance = 25 }
					event_target:th_danmaku_duelist_of_id_1_of_instance_25 = { th_is_danmaku_class = { class = $class$ } }
				}
				AND = {
					th_is_not_danmaku_duel_enemy_target = { country_id = 1 instance = 26 }
					event_target:th_danmaku_duelist_of_id_1_of_instance_26 = { th_is_danmaku_class = { class = $class$ } }
				}
				AND = {
					th_is_not_danmaku_duel_enemy_target = { country_id = 1 instance = 27 }
					event_target:th_danmaku_duelist_of_id_1_of_instance_27 = { th_is_danmaku_class = { class = $class$ } }
				}
				AND = {
					th_is_not_danmaku_duel_enemy_target = { country_id = 1 instance = 28 }
					event_target:th_danmaku_duelist_of_id_1_of_instance_28 = { th_is_danmaku_class = { class = $class$ } }
				}
				AND = {
					th_is_not_danmaku_duel_enemy_target = { country_id = 1 instance = 29 }
					event_target:th_danmaku_duelist_of_id_1_of_instance_29 = { th_is_danmaku_class = { class = $class$ } }
				}
				AND = {
					th_is_not_danmaku_duel_enemy_target = { country_id = 1 instance = 30 }
					event_target:th_danmaku_duelist_of_id_1_of_instance_30 = { th_is_danmaku_class = { class = $class$ } }
				}
				AND = {
					th_is_not_danmaku_duel_enemy_target = { country_id = 2 instance = 1 }
					event_target:th_danmaku_duelist_of_id_2_of_instance_1 = { th_is_danmaku_class = { class = $class$ } }
				}
				AND = {
					th_is_not_danmaku_duel_enemy_target = { country_id = 2 instance = 2 }
					event_target:th_danmaku_duelist_of_id_2_of_instance_2 = { th_is_danmaku_class = { class = $class$ } }
				}
				AND = {
					th_is_not_danmaku_duel_enemy_target = { country_id = 2 instance = 3 }
					event_target:th_danmaku_duelist_of_id_2_of_instance_3 = { th_is_danmaku_class = { class = $class$ } }
				}
				AND = {
					th_is_not_danmaku_duel_enemy_target = { country_id = 2 instance = 4 }
					event_target:th_danmaku_duelist_of_id_2_of_instance_4 = { th_is_danmaku_class = { class = $class$ } }
				}
				AND = {
					th_is_not_danmaku_duel_enemy_target = { country_id = 2 instance = 5 }
					event_target:th_danmaku_duelist_of_id_2_of_instance_5 = { th_is_danmaku_class = { class = $class$ } }
				}
				AND = {
					th_is_not_danmaku_duel_enemy_target = { country_id = 2 instance = 6 }
					event_target:th_danmaku_duelist_of_id_2_of_instance_6 = { th_is_danmaku_class = { class = $class$ } }
				}
				AND = {
					th_is_not_danmaku_duel_enemy_target = { country_id = 2 instance = 7 }
					event_target:th_danmaku_duelist_of_id_2_of_instance_7 = { th_is_danmaku_class = { class = $class$ } }
				}
				AND = {
					th_is_not_danmaku_duel_enemy_target = { country_id = 2 instance = 8 }
					event_target:th_danmaku_duelist_of_id_2_of_instance_8 = { th_is_danmaku_class = { class = $class$ } }
				}
				AND = {
					th_is_not_danmaku_duel_enemy_target = { country_id = 2 instance = 9 }
					event_target:th_danmaku_duelist_of_id_2_of_instance_9 = { th_is_danmaku_class = { class = $class$ } }
				}
				AND = {
					th_is_not_danmaku_duel_enemy_target = { country_id = 2 instance = 10 }
					event_target:th_danmaku_duelist_of_id_2_of_instance_10 = { th_is_danmaku_class = { class = $class$ } }
				}
				AND = {
					th_is_not_danmaku_duel_enemy_target = { country_id = 2 instance = 11 }
					event_target:th_danmaku_duelist_of_id_2_of_instance_11 = { th_is_danmaku_class = { class = $class$ } }
				}
				AND = {
					th_is_not_danmaku_duel_enemy_target = { country_id = 2 instance = 12 }
					event_target:th_danmaku_duelist_of_id_2_of_instance_12 = { th_is_danmaku_class = { class = $class$ } }
				}
				AND = {
					th_is_not_danmaku_duel_enemy_target = { country_id = 2 instance = 13 }
					event_target:th_danmaku_duelist_of_id_2_of_instance_13 = { th_is_danmaku_class = { class = $class$ } }
				}
				AND = {
					th_is_not_danmaku_duel_enemy_target = { country_id = 2 instance = 14 }
					event_target:th_danmaku_duelist_of_id_2_of_instance_14 = { th_is_danmaku_class = { class = $class$ } }
				}
				AND = {
					th_is_not_danmaku_duel_enemy_target = { country_id = 2 instance = 15 }
					event_target:th_danmaku_duelist_of_id_2_of_instance_15 = { th_is_danmaku_class = { class = $class$ } }
				}
				AND = {
					th_is_not_danmaku_duel_enemy_target = { country_id = 2 instance = 16 }
					event_target:th_danmaku_duelist_of_id_2_of_instance_16 = { th_is_danmaku_class = { class = $class$ } }
				}
				AND = {
					th_is_not_danmaku_duel_enemy_target = { country_id = 2 instance = 17 }
					event_target:th_danmaku_duelist_of_id_2_of_instance_17 = { th_is_danmaku_class = { class = $class$ } }
				}
				AND = {
					th_is_not_danmaku_duel_enemy_target = { country_id = 2 instance = 18 }
					event_target:th_danmaku_duelist_of_id_2_of_instance_18 = { th_is_danmaku_class = { class = $class$ } }
				}
				AND = {
					th_is_not_danmaku_duel_enemy_target = { country_id = 2 instance = 19 }
					event_target:th_danmaku_duelist_of_id_2_of_instance_19 = { th_is_danmaku_class = { class = $class$ } }
				}
				AND = {
					th_is_not_danmaku_duel_enemy_target = { country_id = 2 instance = 20 }
					event_target:th_danmaku_duelist_of_id_2_of_instance_20 = { th_is_danmaku_class = { class = $class$ } }
				}
				AND = {
					th_is_not_danmaku_duel_enemy_target = { country_id = 2 instance = 21 }
					event_target:th_danmaku_duelist_of_id_2_of_instance_21 = { th_is_danmaku_class = { class = $class$ } }
				}
				AND = {
					th_is_not_danmaku_duel_enemy_target = { country_id = 2 instance = 22 }
					event_target:th_danmaku_duelist_of_id_2_of_instance_22 = { th_is_danmaku_class = { class = $class$ } }
				}
				AND = {
					th_is_not_danmaku_duel_enemy_target = { country_id = 2 instance = 23 }
					event_target:th_danmaku_duelist_of_id_2_of_instance_23 = { th_is_danmaku_class = { class = $class$ } }
				}
				AND = {
					th_is_not_danmaku_duel_enemy_target = { country_id = 2 instance = 24 }
					event_target:th_danmaku_duelist_of_id_2_of_instance_24 = { th_is_danmaku_class = { class = $class$ } }
				}
				AND = {
					th_is_not_danmaku_duel_enemy_target = { country_id = 2 instance = 25 }
					event_target:th_danmaku_duelist_of_id_2_of_instance_25 = { th_is_danmaku_class = { class = $class$ } }
				}
				AND = {
					th_is_not_danmaku_duel_enemy_target = { country_id = 2 instance = 26 }
					event_target:th_danmaku_duelist_of_id_2_of_instance_26 = { th_is_danmaku_class = { class = $class$ } }
				}
				AND = {
					th_is_not_danmaku_duel_enemy_target = { country_id = 2 instance = 27 }
					event_target:th_danmaku_duelist_of_id_2_of_instance_27 = { th_is_danmaku_class = { class = $class$ } }
				}
				AND = {
					th_is_not_danmaku_duel_enemy_target = { country_id = 2 instance = 28 }
					event_target:th_danmaku_duelist_of_id_2_of_instance_28 = { th_is_danmaku_class = { class = $class$ } }
				}
				AND = {
					th_is_not_danmaku_duel_enemy_target = { country_id = 2 instance = 29 }
					event_target:th_danmaku_duelist_of_id_2_of_instance_29 = { th_is_danmaku_class = { class = $class$ } }
				}
				AND = {
					th_is_not_danmaku_duel_enemy_target = { country_id = 2 instance = 30 }
					event_target:th_danmaku_duelist_of_id_2_of_instance_30 = { th_is_danmaku_class = { class = $class$ } }
				}
			}
		}
	}
}

th_get_logged_actions_for_instance = {
	has_country_flag = th_is_in_danmaku_duel_instance_$instance$
	1 = {
		has_province_flag = th_danmaku_duel_instance_$instance$_online
	}
}

th_check_actions_for_instance = {
	has_country_flag = th_is_in_danmaku_duel_instance_$instance$
	1 = {
		check_variable = {
			which = th_danmaku_duel_logged_actions_for_instance_$instance$
			value = $action$
		}
	}
}

th_check_actions = {
	check_variable = {
		which = th_danmaku_duel_logged_actions
		value = $action$
	}
}

th_select_enemy_event_target_and_check_trigger = {
	OR = {
		AND = { th_is_not_danmaku_duel_enemy_target = { country_id = 1 instance = 1 } event_target:th_danmaku_duelist_of_id_1_of_instance_1 = { $trigger$ } }
		AND = { th_is_not_danmaku_duel_enemy_target = { country_id = 1 instance = 2 } event_target:th_danmaku_duelist_of_id_1_of_instance_2 = { $trigger$ } }
		AND = { th_is_not_danmaku_duel_enemy_target = { country_id = 1 instance = 3 } event_target:th_danmaku_duelist_of_id_1_of_instance_3 = { $trigger$ } }
		AND = { th_is_not_danmaku_duel_enemy_target = { country_id = 1 instance = 4 } event_target:th_danmaku_duelist_of_id_1_of_instance_4 = { $trigger$ } }
		AND = { th_is_not_danmaku_duel_enemy_target = { country_id = 1 instance = 5 } event_target:th_danmaku_duelist_of_id_1_of_instance_5 = { $trigger$ } }
		AND = { th_is_not_danmaku_duel_enemy_target = { country_id = 1 instance = 6 } event_target:th_danmaku_duelist_of_id_1_of_instance_6 = { $trigger$ } }
		AND = { th_is_not_danmaku_duel_enemy_target = { country_id = 1 instance = 7 } event_target:th_danmaku_duelist_of_id_1_of_instance_7 = { $trigger$ } }
		AND = { th_is_not_danmaku_duel_enemy_target = { country_id = 1 instance = 8 } event_target:th_danmaku_duelist_of_id_1_of_instance_8 = { $trigger$ } }
		AND = { th_is_not_danmaku_duel_enemy_target = { country_id = 1 instance = 9 } event_target:th_danmaku_duelist_of_id_1_of_instance_9 = { $trigger$ } }
		AND = { th_is_not_danmaku_duel_enemy_target = { country_id = 1 instance = 10 } event_target:th_danmaku_duelist_of_id_1_of_instance_10 = { $trigger$ } }
		AND = { th_is_not_danmaku_duel_enemy_target = { country_id = 1 instance = 11 } event_target:th_danmaku_duelist_of_id_1_of_instance_11 = { $trigger$ } }
		AND = { th_is_not_danmaku_duel_enemy_target = { country_id = 1 instance = 12 } event_target:th_danmaku_duelist_of_id_1_of_instance_12 = { $trigger$ } }
		AND = { th_is_not_danmaku_duel_enemy_target = { country_id = 1 instance = 13 } event_target:th_danmaku_duelist_of_id_1_of_instance_13 = { $trigger$ } }
		AND = { th_is_not_danmaku_duel_enemy_target = { country_id = 1 instance = 14 } event_target:th_danmaku_duelist_of_id_1_of_instance_14 = { $trigger$ } }
		AND = { th_is_not_danmaku_duel_enemy_target = { country_id = 1 instance = 15 } event_target:th_danmaku_duelist_of_id_1_of_instance_15 = { $trigger$ } }
		AND = { th_is_not_danmaku_duel_enemy_target = { country_id = 1 instance = 16 } event_target:th_danmaku_duelist_of_id_1_of_instance_16 = { $trigger$ } }
		AND = { th_is_not_danmaku_duel_enemy_target = { country_id = 1 instance = 17 } event_target:th_danmaku_duelist_of_id_1_of_instance_17 = { $trigger$ } }
		AND = { th_is_not_danmaku_duel_enemy_target = { country_id = 1 instance = 18 } event_target:th_danmaku_duelist_of_id_1_of_instance_18 = { $trigger$ } }
		AND = { th_is_not_danmaku_duel_enemy_target = { country_id = 1 instance = 19 } event_target:th_danmaku_duelist_of_id_1_of_instance_19 = { $trigger$ } }
		AND = { th_is_not_danmaku_duel_enemy_target = { country_id = 1 instance = 20 } event_target:th_danmaku_duelist_of_id_1_of_instance_20 = { $trigger$ } }
		AND = { th_is_not_danmaku_duel_enemy_target = { country_id = 1 instance = 21 } event_target:th_danmaku_duelist_of_id_1_of_instance_21 = { $trigger$ } }
		AND = { th_is_not_danmaku_duel_enemy_target = { country_id = 1 instance = 22 } event_target:th_danmaku_duelist_of_id_1_of_instance_22 = { $trigger$ } }
		AND = { th_is_not_danmaku_duel_enemy_target = { country_id = 1 instance = 23 } event_target:th_danmaku_duelist_of_id_1_of_instance_23 = { $trigger$ } }
		AND = { th_is_not_danmaku_duel_enemy_target = { country_id = 1 instance = 24 } event_target:th_danmaku_duelist_of_id_1_of_instance_24 = { $trigger$ } }
		AND = { th_is_not_danmaku_duel_enemy_target = { country_id = 1 instance = 25 } event_target:th_danmaku_duelist_of_id_1_of_instance_25 = { $trigger$ } }
		AND = { th_is_not_danmaku_duel_enemy_target = { country_id = 1 instance = 26 } event_target:th_danmaku_duelist_of_id_1_of_instance_26 = { $trigger$ } }
		AND = { th_is_not_danmaku_duel_enemy_target = { country_id = 1 instance = 27 } event_target:th_danmaku_duelist_of_id_1_of_instance_27 = { $trigger$ } }
		AND = { th_is_not_danmaku_duel_enemy_target = { country_id = 1 instance = 28 } event_target:th_danmaku_duelist_of_id_1_of_instance_28 = { $trigger$ } }
		AND = { th_is_not_danmaku_duel_enemy_target = { country_id = 1 instance = 29 } event_target:th_danmaku_duelist_of_id_1_of_instance_29 = { $trigger$ } }
		AND = { th_is_not_danmaku_duel_enemy_target = { country_id = 1 instance = 30 } event_target:th_danmaku_duelist_of_id_1_of_instance_30 = { $trigger$ } }
		AND = { th_is_not_danmaku_duel_enemy_target = { country_id = 2 instance = 1 } event_target:th_danmaku_duelist_of_id_2_of_instance_1 = { $trigger$ } }
		AND = { th_is_not_danmaku_duel_enemy_target = { country_id = 2 instance = 2 } event_target:th_danmaku_duelist_of_id_2_of_instance_2 = { $trigger$ } }
		AND = { th_is_not_danmaku_duel_enemy_target = { country_id = 2 instance = 3 } event_target:th_danmaku_duelist_of_id_2_of_instance_3 = { $trigger$ } }
		AND = { th_is_not_danmaku_duel_enemy_target = { country_id = 2 instance = 4 } event_target:th_danmaku_duelist_of_id_2_of_instance_4 = { $trigger$ } }
		AND = { th_is_not_danmaku_duel_enemy_target = { country_id = 2 instance = 5 } event_target:th_danmaku_duelist_of_id_2_of_instance_5 = { $trigger$ } }
		AND = { th_is_not_danmaku_duel_enemy_target = { country_id = 2 instance = 6 } event_target:th_danmaku_duelist_of_id_2_of_instance_6 = { $trigger$ } }
		AND = { th_is_not_danmaku_duel_enemy_target = { country_id = 2 instance = 7 } event_target:th_danmaku_duelist_of_id_2_of_instance_7 = { $trigger$ } }
		AND = { th_is_not_danmaku_duel_enemy_target = { country_id = 2 instance = 8 } event_target:th_danmaku_duelist_of_id_2_of_instance_8 = { $trigger$ } }
		AND = { th_is_not_danmaku_duel_enemy_target = { country_id = 2 instance = 9 } event_target:th_danmaku_duelist_of_id_2_of_instance_9 = { $trigger$ } }
		AND = { th_is_not_danmaku_duel_enemy_target = { country_id = 2 instance = 10 } event_target:th_danmaku_duelist_of_id_2_of_instance_10 = { $trigger$ } }
		AND = { th_is_not_danmaku_duel_enemy_target = { country_id = 2 instance = 11 } event_target:th_danmaku_duelist_of_id_2_of_instance_11 = { $trigger$ } }
		AND = { th_is_not_danmaku_duel_enemy_target = { country_id = 2 instance = 12 } event_target:th_danmaku_duelist_of_id_2_of_instance_12 = { $trigger$ } }
		AND = { th_is_not_danmaku_duel_enemy_target = { country_id = 2 instance = 13 } event_target:th_danmaku_duelist_of_id_2_of_instance_13 = { $trigger$ } }
		AND = { th_is_not_danmaku_duel_enemy_target = { country_id = 2 instance = 14 } event_target:th_danmaku_duelist_of_id_2_of_instance_14 = { $trigger$ } }
		AND = { th_is_not_danmaku_duel_enemy_target = { country_id = 2 instance = 15 } event_target:th_danmaku_duelist_of_id_2_of_instance_15 = { $trigger$ } }
		AND = { th_is_not_danmaku_duel_enemy_target = { country_id = 2 instance = 16 } event_target:th_danmaku_duelist_of_id_2_of_instance_16 = { $trigger$ } }
		AND = { th_is_not_danmaku_duel_enemy_target = { country_id = 2 instance = 17 } event_target:th_danmaku_duelist_of_id_2_of_instance_17 = { $trigger$ } }
		AND = { th_is_not_danmaku_duel_enemy_target = { country_id = 2 instance = 18 } event_target:th_danmaku_duelist_of_id_2_of_instance_18 = { $trigger$ } }
		AND = { th_is_not_danmaku_duel_enemy_target = { country_id = 2 instance = 19 } event_target:th_danmaku_duelist_of_id_2_of_instance_19 = { $trigger$ } }
		AND = { th_is_not_danmaku_duel_enemy_target = { country_id = 2 instance = 20 } event_target:th_danmaku_duelist_of_id_2_of_instance_20 = { $trigger$ } }
		AND = { th_is_not_danmaku_duel_enemy_target = { country_id = 2 instance = 21 } event_target:th_danmaku_duelist_of_id_2_of_instance_21 = { $trigger$ } }
		AND = { th_is_not_danmaku_duel_enemy_target = { country_id = 2 instance = 22 } event_target:th_danmaku_duelist_of_id_2_of_instance_22 = { $trigger$ } }
		AND = { th_is_not_danmaku_duel_enemy_target = { country_id = 2 instance = 23 } event_target:th_danmaku_duelist_of_id_2_of_instance_23 = { $trigger$ } }
		AND = { th_is_not_danmaku_duel_enemy_target = { country_id = 2 instance = 24 } event_target:th_danmaku_duelist_of_id_2_of_instance_24 = { $trigger$ } }
		AND = { th_is_not_danmaku_duel_enemy_target = { country_id = 2 instance = 25 } event_target:th_danmaku_duelist_of_id_2_of_instance_25 = { $trigger$ } }
		AND = { th_is_not_danmaku_duel_enemy_target = { country_id = 2 instance = 26 } event_target:th_danmaku_duelist_of_id_2_of_instance_26 = { $trigger$ } }
		AND = { th_is_not_danmaku_duel_enemy_target = { country_id = 2 instance = 27 } event_target:th_danmaku_duelist_of_id_2_of_instance_27 = { $trigger$ } }
		AND = { th_is_not_danmaku_duel_enemy_target = { country_id = 2 instance = 28 } event_target:th_danmaku_duelist_of_id_2_of_instance_28 = { $trigger$ } }
		AND = { th_is_not_danmaku_duel_enemy_target = { country_id = 2 instance = 29 } event_target:th_danmaku_duelist_of_id_2_of_instance_29 = { $trigger$ } }
		AND = { th_is_not_danmaku_duel_enemy_target = { country_id = 2 instance = 30 } event_target:th_danmaku_duelist_of_id_2_of_instance_30 = { $trigger$ } }
	}
}

th_has_combat_log_initialized = {
	OR = {
		th_get_logged_actions_for_instance = { instance = 1 }
		th_get_logged_actions_for_instance = { instance = 2 }
		th_get_logged_actions_for_instance = { instance = 3 }
		th_get_logged_actions_for_instance = { instance = 4 }
		th_get_logged_actions_for_instance = { instance = 5 }
		th_get_logged_actions_for_instance = { instance = 6 }
		th_get_logged_actions_for_instance = { instance = 7 }
		th_get_logged_actions_for_instance = { instance = 8 }
		th_get_logged_actions_for_instance = { instance = 9 }
		th_get_logged_actions_for_instance = { instance = 10 }
		th_get_logged_actions_for_instance = { instance = 11 }
		th_get_logged_actions_for_instance = { instance = 12 }
		th_get_logged_actions_for_instance = { instance = 13 }
		th_get_logged_actions_for_instance = { instance = 14 }
		th_get_logged_actions_for_instance = { instance = 15 }
		th_get_logged_actions_for_instance = { instance = 16 }
		th_get_logged_actions_for_instance = { instance = 17 }
		th_get_logged_actions_for_instance = { instance = 18 }
		th_get_logged_actions_for_instance = { instance = 19 }
		th_get_logged_actions_for_instance = { instance = 20 }
		th_get_logged_actions_for_instance = { instance = 21 }
		th_get_logged_actions_for_instance = { instance = 22 }
		th_get_logged_actions_for_instance = { instance = 23 }
		th_get_logged_actions_for_instance = { instance = 24 }
		th_get_logged_actions_for_instance = { instance = 25 }
		th_get_logged_actions_for_instance = { instance = 26 }
		th_get_logged_actions_for_instance = { instance = 27 }
		th_get_logged_actions_for_instance = { instance = 28 }
		th_get_logged_actions_for_instance = { instance = 29 }
		th_get_logged_actions_for_instance = { instance = 30 }
	}
}

th_combat_log_check_flags = {
	has_province_flag = th_danmaku_duel_of_instance_$instance$_action_$action$_actor_NULL
	has_province_flag = th_danmaku_duel_of_instance_$instance$_action_$action$_actor_1
	has_province_flag = th_danmaku_duel_of_instance_$instance$_action_$action$_actor_2
	has_province_flag = th_danmaku_duel_of_instance_$instance$_action_$action$_recipient_NULL
	has_province_flag = th_danmaku_duel_of_instance_$instance$_action_$action$_recipient_1
	has_province_flag = th_danmaku_duel_of_instance_$instance$_action_$action$_recipient_2
	has_province_flag = th_danmaku_duel_of_instance_$instance$_action_$action$_ability_verb_NULL
	has_province_flag = th_danmaku_duel_of_instance_$instance$_action_$action$_ability_verb_uses
	has_province_flag = th_danmaku_duel_of_instance_$instance$_action_$action$_ability_verb_performs
	has_province_flag = th_danmaku_duel_of_instance_$instance$_action_$action$_ability_verb_casts
	has_province_flag = th_danmaku_duel_of_instance_$instance$_action_$action$_ability_verb_enchants
	has_province_flag = th_danmaku_duel_of_instance_$instance$_action_$action$_ability_verb_curses
	has_province_flag = th_danmaku_duel_of_instance_$instance$_action_$action$_ability_verb_strikes
	has_province_flag = th_danmaku_duel_of_instance_$instance$_action_$action$_ability_verb_shoots
	has_province_flag = th_danmaku_duel_of_instance_$instance$_action_$action$_ability_verb_attacks
	has_province_flag = th_danmaku_duel_of_instance_$instance$_action_$action$_ability_article_NULL
	has_province_flag = th_danmaku_duel_of_instance_$instance$_action_$action$_ability_article_undefined
	has_province_flag = th_danmaku_duel_of_instance_$instance$_action_$action$_ability_article_defined
	has_province_flag = th_danmaku_duel_of_instance_$instance$_action_$action$_ability_NULL
	has_province_flag = th_danmaku_duel_of_instance_$instance$_action_$action$_ability_attack
	has_province_flag = th_danmaku_duel_of_instance_$instance$_action_$action$_preposition_NULL
	has_province_flag = th_danmaku_duel_of_instance_$instance$_action_$action$_preposition_against
	has_province_flag = th_danmaku_duel_of_instance_$instance$_action_$action$_preposition_on
	has_province_flag = th_danmaku_duel_of_instance_$instance$_action_$action$_ability_effect_NULL
	has_province_flag = th_danmaku_duel_of_instance_$instance$_action_$action$_ability_effect_miss
	has_province_flag = th_danmaku_duel_of_instance_$instance$_action_$action$_ability_effect_dealing
	has_province_flag = th_danmaku_duel_of_instance_$instance$_action_$action$_ability_effect_healing
	has_province_flag = th_danmaku_duel_of_instance_$instance$_action_$action$_ability_effect_restore
	has_province_flag = th_danmaku_duel_of_instance_$instance$_action_$action$_ability_effect_afflicting_condition
	has_province_flag = th_danmaku_duel_of_instance_$instance$_action_$action$_ability_effect_gaining_condition
	has_province_flag = th_danmaku_duel_of_instance_$instance$_action_$action$_number_impact_NULL
	has_province_flag = th_danmaku_duel_of_instance_$instance$_action_$action$_number_impact_yes
	has_province_flag = th_danmaku_duel_of_instance_$instance$_action_$action$_is_damage_NULL
	has_province_flag = th_danmaku_duel_of_instance_$instance$_action_$action$_is_damage_yes
	has_province_flag = th_danmaku_duel_of_instance_$instance$_action_$action$_is_health_NULL
	has_province_flag = th_danmaku_duel_of_instance_$instance$_action_$action$_is_health_yes
	has_province_flag = th_danmaku_duel_of_instance_$instance$_action_$action$_is_mana_NULL
	has_province_flag = th_danmaku_duel_of_instance_$instance$_action_$action$_is_mana_yes
	has_province_flag = th_danmaku_duel_of_instance_$instance$_action_$action$_is_action_points_NULL
	has_province_flag = th_danmaku_duel_of_instance_$instance$_action_$action$_is_action_points_yes
	has_province_flag = th_danmaku_duel_of_instance_$instance$_action_$action$_is_critical_NULL
	has_province_flag = th_danmaku_duel_of_instance_$instance$_action_$action$_is_critical_yes
	has_province_flag = th_danmaku_duel_of_instance_$instance$_action_$action$_is_miss_NULL
	has_province_flag = th_danmaku_duel_of_instance_$instance$_action_$action$_is_miss_yes
	has_province_flag = th_danmaku_duel_of_instance_$instance$_action_$action$_hit_roll_NULL
	has_province_flag = th_danmaku_duel_of_instance_$instance$_action_$action$_hit_roll_yes
	has_province_flag = th_danmaku_duel_of_instance_$instance$_action_$action$_ability_roll_NULL
	has_province_flag = th_danmaku_duel_of_instance_$instance$_action_$action$_ability_roll_yes
}

#Every action in combat creates the following province_flags for 1:
th_combat_log_get_actor_id = { 					1 = { has_province_flag = th_danmaku_duel_of_instance_$instance$_action_$action$_actor_$actor$ }}
th_combat_log_get_ability_verb = { 				1 = { has_province_flag = th_danmaku_duel_of_instance_$instance$_action_$action$_ability_verb_$verb$ }}
th_combat_log_get_ability_article = { 			1 = { has_province_flag = th_danmaku_duel_of_instance_$instance$_action_$action$_ability_article_$article$ }}
th_combat_log_get_ability_id = { 				1 = { has_province_flag = th_danmaku_duel_of_instance_$instance$_action_$action$_ability_$ability$ }}
th_combat_log_get_preposition = { 				1 = { has_province_flag = th_danmaku_duel_of_instance_$instance$_action_$action$_preposition_$preposition$ }}
th_combat_log_get_recipient_id = { 				1 = { has_province_flag = th_danmaku_duel_of_instance_$instance$_action_$action$_recipient_$recipient$ }}
th_combat_log_get_ability_effect = {			1 = { has_province_flag = th_danmaku_duel_of_instance_$instance$_action_$action$_ability_effect_$ability_effect$ }}
th_combat_log_get_ability_impact_value = { 		1 = { has_province_flag = th_danmaku_duel_of_instance_$instance$_action_$action$_number_impact_$number_impact$ }}
th_combat_log_get_ability_is_damage = { 		1 = { has_province_flag = th_danmaku_duel_of_instance_$instance$_action_$action$_is_damage_$is_damage$ }}
th_combat_log_get_ability_is_health = { 		1 = { has_province_flag = th_danmaku_duel_of_instance_$instance$_action_$action$_is_health_$is_health$ }}
th_combat_log_get_ability_is_mana = { 			1 = { has_province_flag = th_danmaku_duel_of_instance_$instance$_action_$action$_is_mana_$is_mana$ }}
th_combat_log_get_ability_is_action_points = { 	1 = { has_province_flag = th_danmaku_duel_of_instance_$instance$_action_$action$_is_action_points_$is_action_points$ }}
th_combat_log_get_ability_is_critical = { 		1 = { has_province_flag = th_danmaku_duel_of_instance_$instance$_action_$action$_is_critical_$is_critical$ }}
th_combat_log_get_ability_is_miss = { 			1 = { has_province_flag = th_danmaku_duel_of_instance_$instance$_action_$action$_is_miss_$is_miss$ }}
th_combat_log_get_hit_roll = {					1 = { has_province_flag = th_danmaku_duel_of_instance_$instance$_action_$action$_hit_roll_$hit_roll$ }}
th_combat_log_get_ability_roll = {				1 = { has_province_flag = th_danmaku_duel_of_instance_$instance$_action_$action$_ability_roll_$ability_roll$ }}
th_combat_log_unlanded_get_actor_id = { 					 has_country_flag = th_danmaku_duel_action_$action$_actor_$actor$ }
th_combat_log_unlanded_get_ability_verb = { 				 has_country_flag = th_danmaku_duel_action_$action$_ability_verb_$verb$ }
th_combat_log_unlanded_get_ability_article = { 				 has_country_flag = th_danmaku_duel_action_$action$_ability_article_$article$ }
th_combat_log_unlanded_get_ability_id = { 					 has_country_flag = th_danmaku_duel_action_$action$_ability_$ability$ }
th_combat_log_unlanded_get_preposition = { 					 has_country_flag = th_danmaku_duel_action_$action$_preposition_$preposition$ }
th_combat_log_unlanded_get_recipient_id = { 				 has_country_flag = th_danmaku_duel_action_$action$_recipient_$recipient$ }
th_combat_log_unlanded_get_ability_effect = {				 has_country_flag = th_danmaku_duel_action_$action$_ability_effect_$ability_effect$ }
th_combat_log_unlanded_get_ability_impact_value = { 		 has_country_flag = th_danmaku_duel_action_$action$_number_impact_$number_impact$ }
th_combat_log_unlanded_get_ability_is_damage = { 			 has_country_flag = th_danmaku_duel_action_$action$_is_damage_$is_damage$ }
th_combat_log_unlanded_get_ability_is_health = { 			 has_country_flag = th_danmaku_duel_action_$action$_is_health_$is_health$ }
th_combat_log_unlanded_get_ability_is_mana = { 				 has_country_flag = th_danmaku_duel_action_$action$_is_mana_$is_mana$ }
th_combat_log_unlanded_get_ability_is_action_points = { 	 has_country_flag = th_danmaku_duel_action_$action$_is_action_points_$is_action_points$ }
th_combat_log_unlanded_get_ability_is_critical = { 			 has_country_flag = th_danmaku_duel_action_$action$_is_critical_$is_critical$ }
th_combat_log_unlanded_get_ability_is_miss = { 				 has_country_flag = th_danmaku_duel_action_$action$_is_miss_$is_miss$ }
th_combat_log_unlanded_get_hit_roll = {						 has_country_flag = th_danmaku_duel_action_$action$_hit_roll_$hit_roll$ }
th_combat_log_unlanded_get_ability_roll = {					 has_country_flag = th_danmaku_duel_action_$action$_ability_roll_$ability_roll$ }
th_pvp_combat_check_combat_resources_available = {
	check_variable = {
		which = th_danmaku_$type$
		value = $value$
	}
}
th_pve_combat_check_combat_resources_available = {
	check_variable = {
		which = th_enemy_character_current_$type$
		value = $value$
	}
}

th_can_use_ability_attack = {
	th_$type$_combat_check_combat_resources_available = { type = action_points value = 30 }
}
th_can_use_ability = {
	th_can_use_ability_$ability$ = { type = pvp }
}
th_ai_can_use_ability = {
	th_can_use_ability_$ability$ = { type = pve }
}
th_ai_can_use_any_ability = {
	OR = {
		th_ai_can_use_ability = { ability = attack }
	}
}

th_is_alive = {
	check_variable = {
		which = th_danmaku_health
		value = 0.01
	}
}

th_is_alive_solo = {
	check_variable = {
		which = th_enemy_character_current_health
		value = 0.01
	}
}

th_danmaku_duel_is_active = {
	if = {
		limit = {
			has_ruler_flag = th_danmaku_duel_over
			th_select_enemy_event_target_and_check_trigger = {
				trigger = "has_ruler_flag = th_danmaku_duel_over"
			}
		}
		custom_trigger_tooltip = {
			tooltip = th_danmaku_duel_is_active_tt
			OR = {
				NOT = { has_ruler_flag = th_danmaku_duel_over }
				th_select_enemy_event_target_and_check_trigger = {
					trigger = "NOT = { has_ruler_flag = th_danmaku_duel_over }"
				}
			}
		}
	}
}

th_combat_log_check_variable = {
	1 = {
		OR = {
			check_variable = {
				which = th_danmaku_duel_of_instance_$instance$_action_$action$_$type$
				value = 0.01
			}
			NOT = {
				check_variable = {
					which = th_danmaku_duel_of_instance_$instance$_action_$action$_$type$
					value = 0
				}
			}
		}
	}
}

th_combat_log_unlanded_check_variable = {
	OR = {
		check_variable = {
			which = th_danmaku_duel_action_$action$_$type$
			value = 0.01
		}
		NOT = {
			check_variable = {
				which = th_danmaku_duel_action_$action$_$type$
				value = 0
			}
		}
	}
}

th_combat_turn_is_running_out_for_instance = {
	th_get_danmaku_duel_instance = { instance = $instance$ }
	1 = {
		NOT = {
			check_variable = {
				which = th_danmaku_duel_instance_$instance$_turn_duration_counter
				which = th_danmaku_default_turn_duration_alarm
			}
		}
	}
}

th_combat_turn_is_running_out_for_current_instance = {
	OR = {
		th_combat_turn_is_running_out_for_instance = { instance = 1 }
		th_combat_turn_is_running_out_for_instance = { instance = 2 }
		th_combat_turn_is_running_out_for_instance = { instance = 3 }
		th_combat_turn_is_running_out_for_instance = { instance = 4 }
		th_combat_turn_is_running_out_for_instance = { instance = 5 }
		th_combat_turn_is_running_out_for_instance = { instance = 6 }
		th_combat_turn_is_running_out_for_instance = { instance = 7 }
		th_combat_turn_is_running_out_for_instance = { instance = 8 }
		th_combat_turn_is_running_out_for_instance = { instance = 9 }
		th_combat_turn_is_running_out_for_instance = { instance = 10 }
		th_combat_turn_is_running_out_for_instance = { instance = 11 }
		th_combat_turn_is_running_out_for_instance = { instance = 12 }
		th_combat_turn_is_running_out_for_instance = { instance = 13 }
		th_combat_turn_is_running_out_for_instance = { instance = 14 }
		th_combat_turn_is_running_out_for_instance = { instance = 15 }
		th_combat_turn_is_running_out_for_instance = { instance = 16 }
		th_combat_turn_is_running_out_for_instance = { instance = 17 }
		th_combat_turn_is_running_out_for_instance = { instance = 18 }
		th_combat_turn_is_running_out_for_instance = { instance = 19 }
		th_combat_turn_is_running_out_for_instance = { instance = 20 }
		th_combat_turn_is_running_out_for_instance = { instance = 21 }
		th_combat_turn_is_running_out_for_instance = { instance = 22 }
		th_combat_turn_is_running_out_for_instance = { instance = 23 }
		th_combat_turn_is_running_out_for_instance = { instance = 24 }
		th_combat_turn_is_running_out_for_instance = { instance = 25 }
		th_combat_turn_is_running_out_for_instance = { instance = 26 }
		th_combat_turn_is_running_out_for_instance = { instance = 27 }
		th_combat_turn_is_running_out_for_instance = { instance = 28 }
		th_combat_turn_is_running_out_for_instance = { instance = 29 }
		th_combat_turn_is_running_out_for_instance = { instance = 30 }
	}
}

th_combat_turn_is_about_to_run_out = {
	th_is_in_a_danmaku_duel = yes
	th_has_turn_ownership = yes
	OR = {
		AND = {
			th_is_duelling_an_unlanded_character = yes
			NOT = {
				check_variable = {
					which = th_danmaku_unlanded_turn_duration
					which = th_danmaku_unlanded_turn_duration_alert
				}
			}
		}
		th_combat_turn_is_running_out_for_current_instance = yes
	}
}