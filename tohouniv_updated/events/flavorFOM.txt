########################################
# Flavor Events for Forest of Magic
########################################

namespace = flavor_fom

###New Hourai Potion Mission Reward

country_event = {
	id = flavor_fom.1
	title = "flavor_fom.1.t"
	desc = "flavor_fom.1.desc"
	picture = ALCHEMYMARISA_eventPicture
	
	is_triggered_only = yes
	
	option = {	#Let the current ruler drink it
		name = flavor_fom.1.a
		
		add_ruler_personality = immortal_personality
		if = {
			limit = {
				NOT = { has_dlc = "Rights of Man" }
			}
			change_adm = 2
			change_dip = 2 
			change_mil = 2 
		}
		hidden_effect = {
			set_ruler_flag = th_fom_took_potion_descision_flag
			country_event = {
				id = flavor_fom.2
				days = 0
			}
		}
	}
	
	option = {	#Let Marisa drink it
		name = flavor_fom.1.b
		
		trigger = {
			NOT = {
				AND = {
					has_ruler = "Marisa"
					dynasty = "Kirisame"
					is_female = yes
					OR = {
						ruler_has_personality = immortal_personality
						AND = {
							adm = 4
							dip = 3
							mil = 6
						}
					}
				}
			}
			NOT = {
				AND = {
					has_heir = "Marisa"
					heir_has_ruler_dynasty = no
					has_female_heir = yes
					OR = {
						heir_has_personality = immortal_personality
						AND = {
							heir_adm = 4
							heir_dip = 3
							heir_mil = 6
						}
					}
				}
			}
		}
		
		define_ruler = {
			name = "Marisa"
			dynasty = "Kirisame"
			adm = 4
			dip = 3
			mil = 6
			age = 20
			culture = ROOT
			religion = ROOT
			claim = 100
			female = yes
		}
		add_ruler_personality = immortal_personality
		if = {
			limit = {
				NOT = { has_dlc = "Rights of Man" }
			}
			add_mil_power = 75
		}
		hidden_effect = {
			set_ruler_flag = th_fom_took_potion_descision_flag
			country_event = {
				id = flavor_fom.2
				days = 0
			}
		}
	}
	
	option = {	#Let Alice drink it
		name = flavor_fom.1.c
		
		trigger = {
			NOT = {
				AND = {
					has_ruler = "Alice"
					dynasty = "Margatroid"
					is_female = yes
					OR = {
							ruler_has_personality = immortal_personality
							AND = {
							adm = 5
							dip = 4
							mil = 5
						}
					}
				}
			}
			NOT = {
				AND = {
					has_heir = "Alice"
					heir_has_ruler_dynasty = no
					has_female_heir = yes
					OR = {
							heir_has_personality = immortal_personality
							AND = {
							heir_adm = 5
							heir_dip = 4
							heir_mil = 5
						}
					}
				}
			}
		}
		
		define_ruler = {
			name = "Alice"
			dynasty = "Margatroid"
			adm = 6
			dip = 4
			mil = 4
			age = 20
			culture = ROOT
			religion = ROOT
			claim = 100
			female = yes
		}
		add_ruler_personality = immortal_personality
		if = {
			limit = {
				NOT = { has_dlc = "Rights of Man" }
			}
			add_adm_power = 75
		}
		hidden_effect = {
			set_ruler_flag = th_fom_took_potion_descision_flag
			country_event = {
				id = flavor_fom.2
				days = 0
			}
		}
	}
	
	option = {	#Let it be
		name = flavor_fom.1.d
		
		add_adm_power = 150
		add_dip_power = 150
		add_mil_power = 150
		add_prestige = 15
		
		hidden_effect = {
			set_ruler_flag = th_fom_took_potion_descision_flag
			country_event = {
				id = flavor_fom.2
				days = 0
			}
		}
	}
}

country_event = {
	id = flavor_fom.2
	title = "flavor_fom.2.t"
	desc = "flavor_fom.2.desc"
	picture = ALCHEMYMARISA_eventPicture
	
	is_triggered_only = yes
	
	option = {	#Let the current heir drink it
		name = flavor_fom.2.a
		
		trigger = {
			has_heir = yes 
		}
		
		add_heir_personality = immortal_personality
		if = {
			limit = {
				NOT = { has_dlc = "Rights of Man" }
			}
			change_heir_adm  = 2
			change_heir_dip  = 2 
			change_heir_mil  = 2 
		}
		hidden_effect = {
			set_heir_flag = th_fom_took_potion_descision_flag
			set_country_flag = th_fom_hourai_potion 
		}
	}
	
	option = {	#Let Marisa become heir
		name = flavor_fom.2.b
		
		trigger = {
			NOT = {
				AND = {
					has_ruler = "Marisa"
					dynasty = "Kirisame"
					is_female = yes
					OR = {
						 ruler_has_personality = immortal_personality
						 AND = {
							adm = 3
							dip = 3
							mil = 3
						}
					}
				}
			}
			NOT = {
				AND = {
					has_heir = "Marisa"
					heir_has_ruler_dynasty = no
					has_female_heir = yes
					OR = {
						 heir_has_personality = immortal_personality
						 AND = {
							heir_adm = 3
							heir_dip = 3
							heir_mil = 3
						}
					}
				}
			}
		}		
		
		define_heir = {
			name = "Marisa"
			dynasty = "Kirisame"
			adm = 4
			dip = 3
			mil = 6
			age = 20
			culture = ROOT
			religion = ROOT
			claim = 95
			female = yes
		}
		add_heir_personality = immortal_personality
		hidden_effect = {
			set_heir_flag = th_fom_took_potion_descision_flag
			set_country_flag = th_fom_hourai_potion 
		}
	}
	
	option = {	#Let Alice becoma heir
		name = flavor_fom.2.c
		
		trigger = {
			NOT = {
				AND = {
					has_ruler = "Alice"
					dynasty = "Margatroid"
					is_female = yes
					OR = {
						 ruler_has_personality = immortal_personality
						 AND = {
							adm = 3
							dip = 3
							mil = 3
						}
					}
				}
			}
			NOT = {
				AND = {
					has_heir = "Alice"
					heir_has_ruler_dynasty = no
					has_female_heir = yes
					OR = {
						 heir_has_personality = immortal_personality
						 AND = {
							heir_adm = 3
							heir_dip = 3
							heir_mil = 3
						}
					}
				}
			}
		}
		
		define_heir = {
			name = "Alice"
			dynasty = "Margatroid"
			adm = 6
			dip = 4
			mil = 4
			age = 20
			culture = ROOT
			religion = ROOT
			claim = 95
			female = yes
		}
		add_heir_personality = immortal_personality
		hidden_effect = {
			set_heir_flag = th_fom_took_potion_descision_flag
			set_country_flag = th_fom_hourai_potion 
		}
	}
	
	option = {	#Let it be
		name = flavor_fom.2.d
		
		add_adm_power = 150
		add_dip_power = 150
		add_mil_power = 150
		add_prestige = 15		
		
		hidden_effect = {
			set_heir_flag = th_fom_took_potion_descision_flag
			set_country_flag = th_fom_hourai_potion 
		}
	}
}

country_event = {
	id = flavor_fom.3
	title = "flavor_fom.3.t"
	desc = "flavor_fom.3.desc"
	picture = ALCHEMYMARISA_eventPicture

	trigger = {
		has_country_flag = th_fom_hourai_potion
		NOT = { has_ruler_flag = th_fom_took_potion_descision_flag }
		NOT = { has_country_flag = th_fom_currently_chosing_for_ruler }
	}

	mean_time_to_happen = { days = 0 }
	
	immediate = {
		hidden_effect = {
			set_country_flag = th_fom_currently_chosing_for_ruler
		}
	}
	
	option = {	#Let the current ruler drink it
		name = flavor_fom.3.a
		
		add_ruler_personality = immortal_personality
		if = {
			limit = {
				NOT = { has_dlc = "Rights of Man" }
			}
			change_adm = 2
			change_dip = 2 
			change_mil = 2 
		}
		hidden_effect = {
			set_ruler_flag = th_fom_took_potion_descision_flag
			clr_country_flag = th_fom_currently_chosing_for_ruler
		}
	}
	
	option = {	#Let Marisa drink it
		name = flavor_fom.3.b
		
		trigger = {
			NOT = {
				AND = {
					has_ruler = "Marisa"
					dynasty = "Kirisame"
					is_female = yes
					OR = {
						 ruler_has_personality = immortal_personality
						 AND = {
							adm = 3
							dip = 3
							mil = 3
						}
					}
				}
			}
			NOT = {
				AND = {
					has_heir = "Marisa"
					heir_has_ruler_dynasty = no
					has_female_heir = yes
					OR = {
						 heir_has_personality = immortal_personality
						 AND = {
							heir_adm = 3
							heir_dip = 3
							heir_mil = 3
						}
					}
				}
			}
		}
		
		define_ruler = {
			name = "Marisa"
			dynasty = "Kirisame"
			adm = 4
			dip = 3
			mil = 6
			age = 20
			culture = ROOT
			religion = ROOT
			claim = 100
			female = yes
		}
		add_ruler_personality = immortal_personality
		if = {
			limit = {
				NOT = { has_dlc = "Rights of Man" }
			}
			add_mil_power = 75
		}
		hidden_effect = {
			set_ruler_flag = th_fom_took_potion_descision_flag
			clr_country_flag = th_fom_currently_chosing_for_ruler
		}
	}
	
	option = {	#Let Alice drink it
		name = flavor_fom.3.c
		
		trigger = {
			NOT = {
				AND = {
					has_ruler = "Alice"
					dynasty = "Margatroid"
					is_female = yes
					OR = {
						 ruler_has_personality = immortal_personality
						 AND = {
							adm = 3
							dip = 3
							mil = 3
						}
					}
				}
			}
			NOT = {
				AND = {
					has_heir = "Alice"
					heir_has_ruler_dynasty = no
					has_female_heir = yes
					OR = {
						 heir_has_personality = immortal_personality
						 AND = {
							heir_adm = 3
							heir_dip = 3
							heir_mil = 3
						}
					}
				}
			}
		}
		
		define_ruler = {
			name = "Alice"
			dynasty = "Margatroid"
			adm = 6
			dip = 4
			mil = 4
			age = 20
			culture = ROOT
			religion = ROOT
			claim = 100
			female = yes
		}
		add_ruler_personality = immortal_personality
		if = {
			limit = {
				NOT = { has_dlc = "Rights of Man" }
			}
			add_adm_power = 75
		}
		hidden_effect = {
			set_ruler_flag = th_fom_took_potion_descision_flag
			clr_country_flag = th_fom_currently_chosing_for_ruler
		}
	}
	
	option = {	#Let it be
		name = flavor_fom.3.d
		
		add_adm_power = 150
		add_dip_power = 150
		add_mil_power = 150
		add_prestige = 15
		
		hidden_effect = {
			set_ruler_flag = th_fom_took_potion_descision_flag
			clr_country_flag = th_fom_currently_chosing_for_ruler
		}
	}
}

country_event = {
	id = flavor_fom.4
	title = "flavor_fom.4.t"
	desc = "flavor_fom.4.desc"
	picture = ALCHEMYMARISA_eventPicture

	trigger = {
		has_country_flag = th_fom_hourai_potion
		NOT = { has_heir_flag = th_fom_took_potion_descision_flag }
		NOT = { has_ruler_flag = th_fom_chosed_for_heir }
		NOT = { has_country_flag = th_fom_currently_chosing_for_heir }
	}

	mean_time_to_happen = { days = 0 }
	
	immediate = {
		hidden_effect = {
			set_country_flag = th_fom_currently_chosing_for_heir
		}
	}
	
	option = {	#Let the current heir drink it
		name = flavor_fom.4.a
		
		trigger = {
			has_heir = yes 
		}
		
		add_heir_personality = immortal_personality
		if = {
			limit = {
				NOT = { has_dlc = "Rights of Man" }
			}
			change_heir_adm  = 2
			change_heir_dip  = 2 
			change_heir_mil  = 2 
		}
		hidden_effect = {
			set_heir_flag = th_fom_took_potion_descision_flag
			clr_country_flag = th_fom_currently_chosing_for_heir
		}
	}
	
	option = {	#Let Marisa become heir
		name = flavor_fom.4.b
		
		trigger = {
			NOT = {
				AND = {
					has_ruler = "Marisa"
					dynasty = "Kirisame"
					is_female = yes
					OR = {
						 ruler_has_personality = immortal_personality
						 AND = {
							adm = 3
							dip = 3
							mil = 3
						}
					}
				}
			}
			NOT = {
				AND = {
					has_heir = "Marisa"
					heir_has_ruler_dynasty = no
					has_female_heir = yes
					OR = {
						 heir_has_personality = immortal_personality
						 AND = {
							heir_adm = 3
							heir_dip = 3
							heir_mil = 3
						}
					}
				}
			}
		}	
		
		define_heir = {
			name = "Marisa"
			dynasty = "Kirisame"
			adm = 4
			dip = 3
			mil = 6
			age = 20
			culture = ROOT
			religion = ROOT
			claim = 95
			female = yes
		}
		add_heir_personality = immortal_personality
		hidden_effect = {
			set_heir_flag = th_fom_took_potion_descision_flag
			clr_country_flag = th_fom_currently_chosing_for_heir
		}
	}
	
	option = {	#Let Alice become heir
		name = flavor_fom.4.c
		
		trigger = {
			NOT = {
				AND = {
					has_ruler = "Alice"
					dynasty = "Margatroid"
					is_female = yes
					OR = {
						 ruler_has_personality = immortal_personality
						 AND = {
							adm = 3
							dip = 3
							mil = 3
						}
					}
				}
			}
			NOT = {
				AND = {
					has_heir = "Alice"
					heir_has_ruler_dynasty = no
					has_female_heir = yes
					OR = {
						 heir_has_personality = immortal_personality
						 AND = {
							heir_adm = 3
							heir_dip = 3
							heir_mil = 3
						}
					}
				}
			}
		}
		
		define_heir = {
			name = "Alice"
			dynasty = "Margatroid"
			adm = 6
			dip = 4
			mil = 4
			age = 20
			culture = ROOT
			religion = ROOT
			claim = 95
			female = yes
		}
		add_heir_personality = immortal_personality
		hidden_effect = {
			set_heir_flag = th_fom_took_potion_descision_flag
			clr_country_flag = th_fom_currently_chosing_for_heir
		}
	}
	
	option = {	#Let it be
		name = flavor_fom.4.d
		
		add_adm_power = 150
		add_dip_power = 150
		add_mil_power = 150
		add_prestige = 15		
		
		hidden_effect = {
			set_ruler_flag = th_fom_chosed_for_heir
			clr_country_flag = th_fom_currently_chosing_for_heir
		}
	}
}

###Patchy joins FOM###
country_event = {
	id = flavor_fom.5
	title = "flavor_fom.5.t"
	desc = "flavor_fom.5.desc"
	picture = PATCHOULI_eventPicture

	is_triggered_only = yes

	option = {
		name = flavor_fom.5.a
		custom_tooltip = fom_can_hire_patchouli_now_tt
		hidden_effect = {
			set_country_flag = fom_patchouli_joined
		}
						
		ai_chance = { 
			factor = 100
		}
	}
}

###Ellen joins FOM###
country_event = {
	id = flavor_fom.6
	title = "flavor_fom.6.t"
	desc = "flavor_fom.6.desc"
	picture = ELLEN_eventPicture

	is_triggered_only = yes

	option = {
		name = flavor_fom.6.a
		4936 = {
			add_base_tax = 2
			add_base_production = 2
			add_base_manpower = 1
			if = {
				limit = {
					has_global_flag = trade_goods_exapanded_mod_active
				}
				change_trade_goods = magical_artifacts
			}
			add_province_modifier = {
				name = "dominant_trade_hub"
				duration = -1
			}
			change_culture = Magician
			change_province_name = "Ellen's Home"
			rename_capital = "Fluffy Magic Shop"
		}
						
		ai_chance = { 
			factor = 100
		}
	}
}

###Narumi joins FOM###
country_event = {
	id = flavor_fom.7
	title = "flavor_fom.7.t"
	desc = "flavor_fom.7.desc"
	picture = NARUMI_eventPicture

	is_triggered_only = yes

	option = {
		name = flavor_fom.7.a
		
		add_country_modifier = {
			name = fom_jizo_statues
			duration = -1
		}
						
		ai_chance = { 
			factor = 100
		}
	}
}

###Byakuren's Scrolls###
country_event = {
	id = flavor_fom.8
	title = "flavor_fom.8.t"
	desc = "flavor_fom.8.desc"
	picture = BYAKURENSCROLL_eventPicture

	is_triggered_only = yes

	option = {
		name = flavor_fom.8.a
		
		add_country_modifier = {
			name = fom_scroll_of_buddhistic_teachings
			duration = -1
		}
						
		ai_chance = { 
			factor = 33
		}
	}

	option = {
		name = flavor_fom.8.b
		
		add_country_modifier = {
			name = fom_scroll_of_martial_art
			duration = -1
		}
						
		ai_chance = { 
			factor = 33
		}
	}

	option = {
		name = flavor_fom.8.c
		
		add_country_modifier = {
			name = fom_scroll_of_creation
			duration = -1
		}
						
		ai_chance = { 
			factor = 33
		}
	}
}

###Mai and Yuki join###
country_event = {
	id = flavor_fom.9
	title = "flavor_fom.9.t"
	desc = "flavor_fom.9.desc"
	picture = MAIYUKI_eventPicture

	is_triggered_only = yes

	option = {
		name = flavor_fom.9.a
		
		add_country_modifier = {
			name = fom_mai_and_yuki
			duration = -1
		}
						
		ai_chance = { 
			factor = 33
		}
	}
}

###Mage Acedemy is complete!###
country_event = {
	id = flavor_fom.10
	title = "flavor_fom.10.t"
	desc = "flavor_fom.10.desc"
	picture = MAGICALLIBRARY_eventPicture

	is_triggered_only = yes

	option = {
		name = flavor_fom.10.a

		4938 = {
			change_province_name = "Kirisame Academy"
			rename_capital = "Kirisame Academy"
			add_base_tax = 2
			add_base_production = 2
			add_base_manpower = 1
			if = {
				limit = {
					has_global_flag = trade_goods_exapanded_mod_active
				}
				change_trade_goods = magic_tomes
			}
			else = {
				change_trade_goods = paper
			}
			add_permanent_province_modifier = {
				name = fom_academy_of_magic
				duration = -1
			}
		}
		
		add_country_modifier = {
			name = fom_founder_of_the_academy
			duration = -1
		}
						
		ai_chance = { 
			factor = 33
		}
	}
}

#Fight with Mai and Yuki
country_event = {
	id = flavor_fom.12
	title = flavor_fom.12.t
	desc = {
		trigger = {
			custom_trigger_tooltip = {
				tooltip = FOM_recruit_mai_and_yuki_alice_rules
				has_ruler = "Alice"
				dynasty = "Margatroid"
				has_ruler_flag = touhou_character_ruler
			}
		}
		desc = flavor_fom.12.desc.a
	}
	desc = {
		trigger = {
			OR = {
				NOT = { has_ruler = "Alice" }
				NOT = { dynasty = "Margatroid" }
				NOT = { has_ruler_flag = touhou_character_ruler }
			}
		}
		desc = flavor_fom.12.desc.b
	}
	picture = MAIYUKI_eventPicture
	
	is_triggered_only = yes
	
	immediate = {
		hidden_effect = {
			th_getruler_fighting_skill = {
				SKILL_BONI = 0
			}
			#Mai and Yuki
			set_variable = {
				which = th_fom_mai_and_yuki_combat_skills
				value = 1400
			}
			th_defineopponent_fighting_skill = {
				VARIABLE = th_fom_mai_and_yuki_combat_skills
			}
			clr_country_flag = fom_can_fight_mai_yuki
		}
	}
	
	option = {	#TAKE THIS
		name = flavor_fom.12.a
		custom_tooltip = flavor_fom.12.a.tt
		highlight = yes
		th_danmaku_normal_fight_ruler_and_opponent = {
			win_event = flavor_fom.14
			draw_event = flavor_fom.14
			defeat_event = flavor_fom.15
			days = 10
		}

		ai_chance = { 
			factor = 100
		}
	}
}

#Victory over Mai and Yuki
country_event = {
	id = flavor_fom.14
	title = flavor_fom.14.t
	desc = flavor_fom.14.desc
	picture = MAIYUKI_eventPicture
	
	is_triggered_only = yes
	
	option = {
		name = flavor_fom.14.a
		custom_tooltip = flavor_fom.14.a.tt
		add_adm_power = 100
		add_dip_power = 100
		add_mil_power = 200
		hidden_effect = {
			set_country_flag = FOM_defeated_mai_and_yuki
		}

		ai_chance = { 
			factor = 100
		}
	}
}

#Defeat against Mai and Yuki
country_event = {
	id = flavor_fom.15
	title = flavor_fom.15.t
	desc = flavor_fom.15.desc
	picture = MAIYUKI_eventPicture
	
	is_triggered_only = yes
	
	option = {
		name = flavor_fom.15.a
		custom_tooltip = flavor_fom.15.a.tt
		hidden_effect = {
			set_country_flag = fom_can_fight_mai_yuki
			set_country_flag = fom_lost_against_mai_yuki
		}

		ai_chance = { 
			factor = 100
		}
	}
}

#Rumia is happy
country_event = {
	id = flavor_fom.16
	title = "flavor_fom.16.t"
	desc = "flavor_fom.16.desc"
	picture = RUMIA_eventPicture

	is_triggered_only = yes

	option = {
		name = flavor_fom.16.a
		custom_tooltip = flavor_fom.16.a.tt
		hidden_effect = {
			every_country = {
				limit = {
					primary_culture = Gensokyo_human
				}
				add_opinion = {
					who = ROOT
					modifier = th_banished_the_rumia_threat
				}
			}
		}
						
		ai_chance = { 
			factor = 100
		}
	}
}

#Hire Patchouli as an advisor
country_event = {
	id = flavor_fom.102
	title = flavor_fom.102.t
	desc = flavor_fom.102.desc
	picture = SHRINE_eventPicture
	
	is_triggered_only = yes

	hidden = yes

	immediate = {
		hidden_effect = {
			set_country_flag = fom_patchouli_hired
		}
	}

	option = {
		name = flavor_fom.102.a
		if = {
			limit = {
				owns = 4920
			}
			define_advisor = {
				type = th_advisor_patchouli
				name = "Patchouli Knowledge"
				skill = 3
				location = 4920
				discount = yes
				female = yes
				culture = Scarlett
				religion = ROOT
			}
		}
		else_if = {
			limit = {
				owns = 4938
			}
			define_advisor = {
				type = th_advisor_patchouli
				name = "Patchouli Knowledge"
				skill = 3
				location = 4938
				discount = yes
				female = yes
				culture = Scarlett
				religion = ROOT
			}
		}
		else = {
			define_advisor = {
				type = th_advisor_patchouli
				name = "Patchouli Knowledge"
				skill = 3
				discount = yes
				female = yes
				culture = Scarlett
				religion = ROOT
			}
		}
		hidden_effect = {
			country_event = {  		#Clear event after 30 years
				id = flavor_fom.103
				days = 18250
			}
		}

		ai_chance = { 
			factor = 100
		}
	}
}

#Clear of flag, make Patchouli available for hire again
country_event = {
	id = flavor_fom.103
	title = flavor_fom.103.t
	desc = flavor_fom.103.desc
	picture = SHRINE_eventPicture
	
	is_triggered_only = yes
	hidden = yes	

	option = {
		name = flavor_fom.3.a
		clr_country_flag = fom_patchouli_hired

		ai_chance = { 
			factor = 100
		}
	}
}